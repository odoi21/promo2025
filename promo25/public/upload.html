<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subir Fotos</title>

    <!-- Compressor.js para reducir peso de imágenes -->
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1f1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .upload-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        input,
        select,
        button {
            margin: 10px 0;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #218838;
        }

        #uploadStatus {
            margin-top: 10px;
            font-weight: bold;
        }

        .drop-zone {
            border: 2px dashed #aaa;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            color: #555;
            margin-bottom: 15px;
            transition: background-color 0.3s ease;
        }

        .drop-zone.dragover {
            background-color: #f0f0f0;
            border-color: #28a745;
            color: #28a745;
        }
    </style>
</head>

<body>
    <section class="upload-section">
        <h2>Subir fotos</h2>
        <form id="uploadForm">
            <input type="password" id="uploadKey" placeholder="Clave de acceso" required />
            <select id="folder" required>
                <option value="">Seleccionar carpeta</option>
                <option value="Brc">Brc</option>
                <option value="Upd">Upd</option>
                <option value="Fde">Fde</option>
            </select>
            <input type="file" id="fileInput" accept="image/*" multiple required />
            <button type="submit">Subir imágenes</button>
            <div id="dropZone" class="drop-zone">
                Arrastrá imágenes acá o usá el botón
            </div>
            
        </form>
        <p id="uploadStatus"></p>
    </section>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
        const SUPABASE_URL = "VITE_SUPABASE_URL";
        const SUPABASE_KEY = "VITE_SUPABASE_ANON_KEY";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const CLAVE_CORRECTA = "2025egresados";

        document.getElementById("uploadForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const keyInput = document.getElementById("uploadKey").value;
            const folder = document.getElementById("folder").value;
            const files = Array.from(document.getElementById("fileInput").files);
            const status = document.getElementById("uploadStatus");

            if (keyInput !== CLAVE_CORRECTA) {
                status.textContent = "Clave incorrecta ❌";
                status.style.color = "red";
                return;
            }

            if (files.length === 0 || !folder) {
                status.textContent = "Falta seleccionar archivo o carpeta.";
                status.style.color = "red";
                return;
            }

            if (files.length > 5) {
                status.textContent = "Máximo 5 imágenes por subida.";
                status.style.color = "red";
                return;
            }

            status.textContent = "Verificando duplicados...";
            status.style.color = "black";

            // Obtener archivos ya subidos en esa carpeta
            const { data: existentes, error: errorExistentes } = await supabase
                .storage
                .from("fotosAnos")
                .list(folder);

            if (errorExistentes) {
                status.textContent = `Error al verificar duplicados: ${errorExistentes.message}`;
                status.style.color = "red";
                return;
            }

            const nombresExistentes = existentes.map(f => f.name.split('-').slice(1).join('-'));
            const archivosUnicos = files.filter(file => !nombresExistentes.includes(file.name));

            if (archivosUnicos.length === 0) {
                status.textContent = "Todas las imágenes ya fueron subidas.";
                status.style.color = "orange";
                return;
            }

            status.textContent = "Subiendo imágenes...";
            status.style.color = "black";

            for (const file of archivosUnicos) {
                await new Promise((resolve, reject) => {
                    new Compressor(file, {
                        quality: 0.6,
                        maxWidth: 1600,
                        success(compressedFile) {
                            const fileName = `${folder}/${Date.now()}-${compressedFile.name}`;

                            supabase.storage
                                .from("fotosAnos")
                                .upload(fileName, compressedFile)
                                .then(({ error: uploadError }) => {
                                    if (uploadError) {
                                        status.textContent = `Error al subir ${file.name}: ${uploadError.message}`;
                                        status.style.color = "red";
                                        reject();
                                        return;
                                    }

                                    const { data: publicUrlData } = supabase.storage
                                        .from("fotosAnos")
                                        .getPublicUrl(fileName);

                                    const imageUrl = publicUrlData.publicUrl;

                                    supabase.from("galeria").insert([
                                        { url: imageUrl, fiesta: folder },
                                    ]).then(({ error: insertError }) => {
                                        if (insertError) {
                                            status.textContent = `Error al guardar ${file.name} en DB: ${insertError.message}`;
                                            status.style.color = "red";
                                            reject();
                                            return;
                                        }

                                        resolve();
                                    });
                                });
                        },
                        error(err) {
                            status.textContent = `Error al comprimir ${file.name}: ${err.message}`;
                            status.style.color = "red";
                            reject();
                        },
                    });
                });
            }

            status.textContent = "✅ Imágenes subidas correctamente.";
            status.style.color = "green";
        });


        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");

        dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", () => {
            dropZone.classList.remove("dragover");
        });

        dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.classList.remove("dragover");

            const droppedFiles = Array.from(e.dataTransfer.files);
            fileInput.files = createFileList(droppedFiles);
        });

        // Helper para convertir array a FileList
        function createFileList(files) {
            const dataTransfer = new DataTransfer();
            files.forEach(file => dataTransfer.items.add(file));
            return dataTransfer.files;
        }
    </script>
</body>

</html>